version: "3.9"

services:
  kubo:
    image: ipfs/kubo:latest
    container_name: spaceaware-kubo
    environment:
      - IPFS_PATH=/data/ipfs
    volumes:
      - ipfs_data:/data/ipfs
      - ./config/kubo/init.d:/container-init.d:ro
    ports:
      # Swarm (4001 is taken by SDN P2P, use 4002 on host)
      - "4002:4001/tcp"
      - "4002:4001/udp"
      # API and Gateway stay internal â€” proxied via SDN admin server
    restart: unless-stopped
    networks: [spaceaware]

  sdn-node:
    image: ${SDN_SERVER_IMAGE}
    container_name: spaceaware-sdn-node
    command: ["spacedatanetwork", "daemon", "--config", "/etc/sdn/config.yaml"]
    environment:
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL}
      SDN_LICENSE_ADMIN_TOKEN: ${SDN_LICENSE_ADMIN_TOKEN}
      SDN_PLUGIN_ROOT: ${SDN_PLUGIN_ROOT}
      HD_WALLET_WASM_PATH: /opt/wasm/hd-wallet.wasm
    volumes:
      - /opt/data/sdn:/opt/data/sdn
      - /opt/data/raw:/opt/data/raw
      - /opt/data/keys:/opt/data/keys
      - /opt/data/license:/opt/data/license
      - ./config/sdn:/etc/sdn:ro
    ports:
      - "4001:4001"
      - "4001:4001/udp"
      - "8080:8080"
      - "5001:5001"
    depends_on: [kubo]
    restart: unless-stopped
    networks: [spaceaware]

  sdn-ingest:
    image: ${SDN_SERVER_IMAGE}
    container_name: spaceaware-sdn-ingest
    command:
      [
        "spacedatanetwork",
        "ingest",
        "--config",
        "/etc/sdn/config.yaml",
        "--storage-path",
        "/opt/data/sdn",
        "--raw-path",
        "/opt/data/raw",
        "--celestrak-interval",
        "1h",
        "--satcat-interval",
        "24h",
        "--spacetrack-enabled",
        "true",
        "--spacetrack-batch-days",
        "3",
        "--spacetrack-batch-sleep",
        "3s"
      ]
    environment:
      SPACETRACK_IDENTITY: ${SPACETRACK_IDENTITY}
      SPACETRACK_PASSWORD: ${SPACETRACK_PASSWORD}
    volumes:
      - /opt/data/sdn:/opt/data/sdn
      - /opt/data/raw:/opt/data/raw
      - ./config/sdn:/etc/sdn:ro
    depends_on: [sdn-node]
    restart: unless-stopped
    networks: [spaceaware]

  orbpro-license:
    image: ${ORBPRO_LICENSE_IMAGE}
    container_name: spaceaware-orbpro-license
    environment:
      LICENSE_PROTOCOL: /orbpro/license/1.0.0
      SDN_BOOTSTRAP: ${PUBLIC_BOOTSTRAP_ADDR}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      ENTITLEMENTS_DB: /opt/data/license/entitlements.db
    volumes:
      - /opt/data/license:/opt/data/license
    depends_on: [sdn-node]
    restart: unless-stopped
    networks: [spaceaware]

volumes:
  ipfs_data:

networks:
  spaceaware:
    driver: bridge
