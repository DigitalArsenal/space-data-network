<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPACE DATA NETWORK</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        margin: 0;
        padding: 0;
        padding-bottom: env(
          safe-area-inset-bottom
        ); /* Adjust for iOS safe area */
        background-color: #f4f4f9;
        color: #333;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        position: fixed;
      }

      header {
        user-select: none;
        background-color: #282c34;
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
      }

      .header-title {
        flex-grow: 1;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 200;
        margin: 0;
        text-align: left;
      }

      .header-buttons {
        display: flex;
        gap: 10px;
        flex-shrink: 0;
      }

      main {
        flex: 1;
        position: relative;
      }

      footer {
        border-top: 1px silver solid;
        text-align: center;
        padding: 10px;
        padding-bottom: calc(
          10px + env(safe-area-inset-bottom)
        ); /* Adjust for iOS safe area */
        background-color: #282c34;
        color: white;
        font-size: 1rem;
        font-weight: 300;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        max-width: 700px; /* Adjusted for better fitting */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.3s;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      /* Button styles */
      .header-button {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        user-select: all;
      }

      .header-button:hover {
        background-color: #005f99;
      }

      /* Toast notification styling */
      #toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
        font-size: 17px;
        opacity: 0;
        transition: opacity 0.6s, visibility 0s linear 0.6s;
      }

      #toast.show {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.6s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* Full page globe background */
      .globe-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 0;
      }

      /* Modal content table styling */
      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 10px; /* Ensure sufficient padding */
        text-align: left;
        word-wrap: break-word; /* Wrap text in cells */
      }
      /* Additional style to prevent overflow */
      td {
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px; /* Max width for cells to contain content */
      }
      th {
        background-color: #f4f4f9;
        color: #007acc;
        font-weight: bold;
        text-transform: uppercase;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      td.clickable {
        cursor: pointer;
        color: #007acc;
        text-decoration: underline;
        font-size: small;
      }

      /* Modal display control */
      .modal-open {
        display: flex !important;
      }

      /* Responsive styles for smaller screens */
      @media screen and (max-width: 600px) {
        body {
          font-size: 14px;
        }

        .header-title {
          font-size: 1.2rem;
        }

        .header-button {
          padding: 5px 10px;
          font-size: 0.8rem;
        }

        .modal-content {
          width: 90%;
          max-width: 90%;
        }

        /* Adjust modal table font size */
        .modal-content table {
          font-size: 0.9rem;
        }
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/orbpro@1.120.14/style/widgets.css"
    />
    <script type="module">
      import * as OrbPro from "https://cdn.jsdelivr.net/npm/orbpro@1.120.14/dist/index.js";

      const testOrbPro = async () => {
        try {
          globalThis.OrbPro = OrbPro;
          console.log("Testing OrbProJS module...");
          if (OrbPro) {
            console.log("OrbProJS module imported successfully:", OrbPro);
            console.log(OrbPro.Viewer);
            const viewer = new OrbPro.Viewer(
              document.querySelector(".globe-container"),
              {
                timeline: false,
                timelineContainer: true,
              }
            );
            new OrbPro.DynamicTimeline(viewer.timeline.container, viewer);
            console.log("Viewer initialized:", viewer);
          } else {
            console.error("Failed to import OrbProJS module");
          }
        } catch (error) {
          console.error("Error during OrbProJS module testing:", error);
        }
      };

      testOrbPro();
    </script>
    <script>
      function showToast(message, success) {
        const toast = document.getElementById("toast");
        toast.innerHTML = message;
        toast.style.backgroundColor = success ? "#4CAF50" : "#f44336"; // Green for success, red for failure
        toast.className = "show";

        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000); // Hide the toast after 3 seconds
      }

      // Function to check if the page is loaded over HTTPS
      function isPageOverHTTPS() {
        return window.location.protocol === "https:";
      }

      // Function to send the request for domain verification
      function verifyDomain() {
        // Only proceed if the page is not loaded over HTTPS
        if (isPageOverHTTPS()) {
          console.log(
            "Page is already loaded over HTTPS, no need to verify domain."
          );
          return;
        }

        // Send the GET request to verify the domain
        fetch(
          `/verify-domain?domain=${encodeURIComponent(
            window.location.hostname
          )}`,
          {
            method: "GET",
          }
        )
          .then((response) => {
            if (response.ok) {
              return response.json(); // Parse JSON response
            } else {
              throw new Error(
                `Domain verification failed with status: ${response.status}`
              );
            }
          })
          .then((data) => {
            // Log the domain verification data if successful
            console.log("Domain verification successful.");
            console.log("Verified Domain:", data.domain);
            console.log("Node IPs:", data.node_ips);
            // If domain verification is successful, redirect to HTTPS after 5 seconds
            console.log("Redirecting to HTTPS in 5 seconds...");

            setTimeout(() => {
              // Redirect to the HTTPS version of the page
              window.location.href = `https://${window.location.hostname}${window.location.pathname}`;
            }, 5000);
          })
          .catch((error) => {
            // Log any errors encountered during the verification process
            console.error("Error during domain verification:", error.message);
          });
      }

      // Call the verifyDomain function when the page is loaded
      window.addEventListener("load", verifyDomain);

      function submitTestForm() {
        const signature =
          "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        const message = "TEST";

        fetch("/verify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Signature": signature,
            "X-Message": message,
          },
        })
          .then((response) => {
            if (response.ok) {
              showToast("Success! Signature verified.", true);
            } else {
              showToast("Failure! Signature invalid.", false);
            }
          })
          .catch((error) => {
            showToast("Error occurred. Try again.", false);
          });
      }

      function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
          const tooltip = element.querySelector(".tooltiptext");
          tooltip.innerHTML = "Copied!";
          setTimeout(() => {
            tooltip.innerHTML = "Click to copy";
          }, 1500);
        });
      }

      // Modal controls
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("modal-open");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("modal-open");
      }
    </script>
  </head>
  <body>
    <header>
      <h1 class="header-title">SPACE DATA NETWORK</h1>
      <div class="header-buttons">
        <button class="header-button" onclick="openModal('serverInfoModal')">
          Server Info
        </button>
        <button class="header-button" onclick="openModal('testFormModal')">
          Test Form
        </button>
      </div>
    </header>
    <main>
      <div class="globe-container"></div>
    </main>

    <footer>
      &copy;
      <script>
        document.write(new Date().getFullYear());
      </script>
      <a
        href="https://digitalarsenal.io"
        target="_blank"
        style="color: white; text-decoration: none"
      >
        DigitalArsenal.io, Inc.
      </a>
      and
      <a
        href="https://lyteworx.com"
        target="_blank"
        style="color: white; text-decoration: none"
      >
        Lyteworx Automation Systems, Inc.
      </a>
    </footer>

    <!-- Server Info Modal -->
    <div id="serverInfoModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('serverInfoModal')"
          >&times;</span
        >
        <h2>Node Information</h2>
        <table>
          <tr>
            <td>Node Public Key</td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.PublicKey}}', this)"
            >
              {{.PublicKey}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
          <tr>
            <td>Node PeerID</td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.PeerID}}', this)"
            >
              {{.PeerID}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
          <tr>
            <td>
              Node Signing Ethereum Address
              <a
                href="https://etherscan.io/address/{{.SigningAddress}}"
                target="_blank"
                class="link-icon"
              >
                &#x1F517;
                <!-- External link icon -->
              </a>
            </td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.SigningAddress}}', this)"
            >
              {{.SigningAddress}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
          <tr>
            <td>
              Node Encryption Ethereum Address
              <a
                href="https://etherscan.io/address/{{.EncryptionAddress}}"
                target="_blank"
                class="link-icon"
              >
                &#x1F517;
                <!-- External link icon -->
              </a>
            </td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.EncryptionAddress}}', this)"
            >
              {{.EncryptionAddress}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
          <tr>
            <td>IPNS Base32 Encoded CIDv1</td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.Base32CIDv1}}', this)"
            >
              {{.Base32CIDv1}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
          <tr>
            <td>IPNS Base36 Encoded CIDv1</td>
            <td
              class="clickable tooltip"
              onclick="copyToClipboard('{{.Base36CIDv1}}', this)"
            >
              {{.Base36CIDv1}}
              <span class="tooltiptext"></span>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Test Form Modal -->
    <div id="testFormModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('testFormModal')">&times;</span>
        <h2>Submit Test Form</h2>
        <div class="test-form">
          <input type="button" value="Submit Test" onclick="submitTestForm()" />
        </div>
      </div>
    </div>

    <div id="toast"></div>
  </body>
</html>
